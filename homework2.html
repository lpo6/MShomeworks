<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计模拟器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        /* 左侧导航栏样式 */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .nav-links {
            list-style: none;
            flex-grow: 1;
        }
        
        .nav-links li {
            padding: 0;
            margin: 5px 15px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .nav-links a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .nav-links i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* 主内容区样式 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .simulator-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
            display: none;
        }
        
        .simulator-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header h2 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .section-header p {
            color: #7f8c8d;
            line-height: 1.6;
        }
        
        /* 新的布局结构 */
        .controls-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #34495e;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #4a69bd;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #3c5aa8;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .visualization-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .simulator-canvas {
            flex: 1;
            min-width: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .chart-container {
            flex: 1;
            min-width: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            height: 400px;
        }
        
        .results {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4a69bd;
            margin-top: 20px;
        }
        
        .results h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .result-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }
        
        .result-item .label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .result-item .value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* 主页样式 */
        .welcome-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-section h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .welcome-section p {
            font-size: 1.1rem;
            color: #7f8c8d;
            max-width: 800px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .feature-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: #4a69bd;
            margin-bottom: 15px;
        }
        
        .feature-card h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .feature-card p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 900px) {
            .features {
                grid-template-columns: 1fr;
            }
            
            .visualization-container {
                flex-direction: column;
            }
            
            .simulator-canvas, .chart-container {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 10px 0;
            }
            
            .nav-links {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-links li {
                margin: 5px;
            }
            
            .nav-links a {
                padding: 10px 15px;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 左侧导航栏 -->
    <div class="sidebar">
        <div class="logo">
            <h1>统计模拟器</h1>
        </div>
        
        <ul class="nav-links">
            <li><a href="#" class="active" data-target="welcome">首页</a></li>
            <li><a href="#" data-target="buffon">蒲丰投针</a></li>
            <li><a href="#" data-target="galton">高尔顿钉板</a></li>
            <li><a href="#" data-target="birthday">生日问题</a></li>
            <li><a href="#" data-target="room">分房问题</a></li>
        </ul>
        
        <div class="footer">
            <p>统计模拟实验平台 &copy; 2023</p>
        </div>
    </div>
    
    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 欢迎部分 -->
        <div id="welcome" class="simulator-section active">
            <div class="welcome-section">
                <h1>统计模拟实验平台</h1>
                <p>探索概率与统计的奇妙世界！本平台提供四种经典的统计模拟实验，通过交互式可视化帮助您理解复杂的统计概念。</p>
                
                <div class="features">
                    <div class="feature-card" data-target="buffon">
                        <div class="feature-icon">📌</div>
                        <h3>蒲丰投针</h3>
                        <p>通过随机投针实验估算圆周率π的值，体验几何概率的奇妙应用。</p>
                    </div>
                    
                    <div class="feature-card" data-target="galton">
                        <div class="feature-icon">📊</div>
                        <h3>高尔顿钉板</h3>
                        <p>模拟小球通过钉板后的分布，直观演示正态分布的形成过程。</p>
                    </div>
                    
                    <div class="feature-card" data-target="birthday">
                        <div class="feature-icon">🎂</div>
                        <h3>生日问题</h3>
                        <p>探索人群中生日相同的概率，理解反直觉的概率现象。</p>
                    </div>
                    
                    <div class="feature-card" data-target="room">
                        <div class="feature-icon">🏨</div>
                        <h3>分房问题</h3>
                        <p>模拟客人随机入住房间的过程，研究 occupancy 分布问题。</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 蒲丰投针模块 -->
        <div id="buffon" class="simulator-section">
            <div class="section-header">
                <h2>蒲丰投针实验</h2>
                <p>通过随机投针实验来估算圆周率π的值。当针与平行线相交时，计数增加，根据大量实验的结果可以计算出π的近似值。</p>
            </div>
            
            <!-- 参数控制区域 -->
            <div class="controls-container">
                <div class="control-group">
                    <label for="needleLength">针的长度 (相对于线间距)</label>
                    <input type="range" id="needleLength" min="0.1" max="2" step="0.1" value="1">
                    <span id="needleLengthValue">1.0</span>
                </div>
                
                <div class="control-group">
                    <label for="needleCount">投针次数</label>
                    <input type="number" id="needleCount" min="1" max="10000" value="100">
                </div>
                
                <div class="control-group">
                    <label for="animationSpeed">动画速度</label>
                    <select id="animationSpeed">
                        <option value="slow">慢速</option>
                        <option value="medium" selected>中速</option>
                        <option value="fast">快速</option>
                        <option value="instant">立即完成</option>
                    </select>
                </div>
                
                <div class="buttons-container">
                    <button id="startBuffon" class="btn">开始模拟</button>
                    <button id="resetBuffon" class="btn btn-secondary">重置</button>
                </div>
            </div>
            
            <!-- 可视化区域 -->
            <div class="visualization-container">
                <div class="simulator-canvas">
                    <!-- 蒲丰投针画布 -->
                    <canvas id="buffonCanvas" width="500" height="400"></canvas>
                </div>
                
                <div class="chart-container">
                    <!-- 蒲丰投针结果图表 -->
                    <canvas id="buffonChart"></canvas>
                </div>
            </div>
            
            <!-- 结果区域 -->
            <div class="results">
                <h3>模拟结果</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="label">总投针数</div>
                        <div class="value" id="totalNeedles">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">相交次数</div>
                        <div class="value" id="crossings">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">π的估计值</div>
                        <div class="value" id="piEstimate">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">误差</div>
                        <div class="value" id="piError">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 高尔顿钉板模块 -->
        <div id="galton" class="simulator-section">
            <div class="section-header">
                <h2>高尔顿钉板实验</h2>
                <p>模拟小球通过多层钉板后的分布情况，展示中心极限定理的实际应用，以及正态分布的形成过程。</p>
            </div>
            
            <!-- 参数控制区域 -->
            <div class="controls-container">
                <div class="control-group">
                    <label for="boardRows">钉板行数</label>
                    <input type="number" id="boardRows" min="5" max="20" value="10">
                </div>
                
                <div class="control-group">
                    <label for="ballCount">小球数量</label>
                    <input type="number" id="ballCount" min="10" max="10000" value="500">
                </div>
                
                <div class="control-group">
                    <label for="galtonAnimationSpeed">动画速度</label>
                    <select id="galtonAnimationSpeed">
                        <option value="slow">慢速</option>
                        <option value="medium" selected>中速</option>
                        <option value="fast">快速</option>
                        <option value="instant">立即完成</option>
                    </select>
                </div>
                
                <div class="buttons-container">
                    <button id="startGalton" class="btn">开始模拟</button>
                    <button id="resetGalton" class="btn btn-secondary">重置</button>
                </div>
            </div>
            
            <!-- 可视化区域 -->
            <div class="visualization-container">
                <div class="simulator-canvas">
                    <!-- 高尔顿钉板画布 -->
                    <canvas id="galtonCanvas" width="500" height="400"></canvas>
                </div>
                
                <div class="chart-container">
                    <!-- 高尔顿钉板结果图表 -->
                    <canvas id="galtonChart"></canvas>
                </div>
            </div>
            
            <!-- 结果区域 -->
            <div class="results">
                <h3>模拟结果</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="label">已下落小球</div>
                        <div class="value" id="ballsDropped">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">分布形状</div>
                        <div class="value" id="distributionShape">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 生日问题模块 -->
        <div id="birthday" class="simulator-section">
            <div class="section-header">
                <h2>生日问题</h2>
                <p>探索在一个群体中至少两人共享同一生日的概率。结果往往比直觉预期的要高得多，这是一个经典的概率悖论。</p>
            </div>
            
            <!-- 参数控制区域 -->
            <div class="controls-container">
                <div class="control-group">
                    <label for="groupSize">群体大小</label>
                    <input type="number" id="groupSize" min="2" max="100" value="23">
                </div>
                
                <div class="control-group">
                    <label for="simulationCount">模拟次数</label>
                    <input type="number" id="simulationCount" min="10" max="10000" value="100">
                </div>
                
                <div class="buttons-container">
                    <button id="startBirthday" class="btn">开始模拟</button>
                    <button id="resetBirthday" class="btn btn-secondary">重置</button>
                </div>
            </div>
            
            <!-- 可视化区域 -->
            <div class="visualization-container">
                <div class="simulator-canvas">
                    <!-- 生日问题可视化 -->
                    <canvas id="birthdayCanvas" width="500" height="400"></canvas>
                </div>
                
                <div class="chart-container">
                    <!-- 生日问题结果图表 -->
                    <canvas id="birthdayChart"></canvas>
                </div>
            </div>
            
            <!-- 结果区域 -->
            <div class="results">
                <h3>模拟结果</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="label">模拟次数</div>
                        <div class="value" id="simulationsRun">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">有相同生日的比例</div>
                        <div class="value" id="sameBirthdayRatio">0%</div>
                    </div>
                    <div class="result-item">
                        <div class="label">理论概率</div>
                        <div class="value" id="theoreticalProbability">0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分房问题模块 -->
        <div id="room" class="simulator-section">
            <div class="section-header">
                <h2>分房问题</h2>
                <p>模拟客人随机选择房间的过程，研究房间占用分布。也称为" occupancy problem"，是概率论中的经典问题。</p>
            </div>
            
            <!-- 参数控制区域 -->
            <div class="controls-container">
                <div class="control-group">
                    <label for="roomCount">房间数量</label>
                    <input type="number" id="roomCount" min="10" max="1000" value="100">
                </div>
                
                <div class="control-group">
                    <label for="guestCount">客人数量</label>
                    <input type="number" id="guestCount" min="10" max="10000" value="200">
                </div>
                
                <div class="control-group">
                    <label for="preset">预设场景</label>
                    <select id="preset">
                        <option value="custom">自定义</option>
                        <option value="birthday">生日问题类似 (n=23, k=365)</option>
                        <option value="coupon">优惠券收集问题 (n=完整集)</option>
                        <option value="hash">哈希冲突 (n=元素, k=桶)</option>
                    </select>
                </div>
                
                <div class="buttons-container">
                    <button id="startRoom" class="btn">开始模拟</button>
                    <button id="resetRoom" class="btn btn-secondary">重置</button>
                </div>
            </div>
            
            <!-- 可视化区域 -->
            <div class="visualization-container">
                <div class="simulator-canvas">
                    <!-- 分房问题可视化 -->
                    <canvas id="roomCanvas" width="500" height="400"></canvas>
                </div>
                
                <div class="chart-container">
                    <!-- 分房问题结果图表 -->
                    <canvas id="roomChart"></canvas>
                </div>
            </div>
            
            <!-- 结果区域 -->
            <div class="results">
                <h3>模拟结果</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="label">空房间数</div>
                        <div class="value" id="emptyRooms">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">最多客人的房间</div>
                        <div class="value" id="maxGuests">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">平均每房客人数</div>
                        <div class="value" id="avgGuests">0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">分布类型</div>
                        <div class="value" id="distributionType">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 导航功能
        document.querySelectorAll('.nav-links a, .feature-card').forEach(element => {
            element.addEventListener('click', function(e) {
                e.preventDefault();
                
                const targetId = this.getAttribute('data-target');
                
                // 更新活动链接
                document.querySelectorAll('.nav-links a').forEach(l => {
                    if (l.getAttribute('data-target') === targetId) {
                        l.classList.add('active');
                    } else {
                        l.classList.remove('active');
                    }
                });
                
                // 显示对应部分
                document.querySelectorAll('.simulator-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetId).classList.add('active');
                
                // 滚动到顶部
                window.scrollTo(0, 0);
            });
        });
        
        // 蒲丰投针滑块值显示
        const needleLengthSlider = document.getElementById('needleLength');
        const needleLengthValue = document.getElementById('needleLengthValue');
        
        if (needleLengthSlider && needleLengthValue) {
            needleLengthSlider.addEventListener('input', function() {
                needleLengthValue.textContent = this.value;
            });
        }
        
        // 初始化所有图表
    const initCharts = () => {
    // 蒲丰投针图表
    const buffonCtx = document.getElementById('buffonChart');
    if (buffonCtx) {
        window.buffonChart = new Chart(buffonCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'π估计值',
                    data: [],
                    borderColor: '#4a69bd',
                    backgroundColor: 'rgba(74, 105, 189, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'π估计值随投针次数的变化'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `π ≈ ${context.raw.toFixed(4)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'π估计值'
                        },
                        suggestedMin: 2.5,
                        suggestedMax: 3.5
                    },
                    x: {
                        title: {
                            display: true,
                            text: '投针次数'
                        }
                    }
                }
            }
        });
    }
    
    // 高尔顿钉板图表
    const galtonCtx = document.getElementById('galtonChart');
    if (galtonCtx) {
        window.galtonChart = new Chart(galtonCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: '小球数量',
                    data: [],
                    backgroundColor: '#4a69bd',
                    borderColor: '#2c3e50',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '小球分布直方图'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '小球数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '槽位'
                        }
                    }
                }
            }
        });
    }
    
    // 生日问题图表
    const birthdayCtx = document.getElementById('birthdayChart');
    if (birthdayCtx) {
        window.birthdayChart = new Chart(birthdayCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: '模拟概率',
                        data: [],
                        borderColor: '#4a69bd',
                        backgroundColor: 'rgba(74, 105, 189, 0.1)',
                        tension: 0.2,
                        fill: true
                    },
                    {
                        label: '理论概率',
                        data: [],
                        borderColor: '#e74c3c',
                        borderDash: [5, 5],
                        tension: 0.2,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '生日相同概率随群体大小的变化'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${(context.raw * 100).toFixed(2)}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 1,
                        title: {
                            display: true,
                            text: '概率'
                        },
                        ticks: {
                            callback: function(value) {
                                return (value * 100) + '%';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '群体大小'
                        }
                    }
                }
            }
        });
    }
    
    // 分房问题图表
    const roomCtx = document.getElementById('roomChart');
    if (roomCtx) {
        window.roomChart = new Chart(roomCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: '房间数量',
                    data: [],
                    backgroundColor: '#4a69bd',
                    borderColor: '#2c3e50',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '房间占用分布'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return `占用 ${context[0].label} 位客人的房间`;
                            },
                            label: function(context) {
                                return `数量: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '房间数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '客人数量'
                        }
                    }
                }
            }
        });
    }
};
        
        // 页面加载完成后初始化
        window.addEventListener('load', initCharts);
        
        // 这里将添加各模拟器的具体实现代码
        // 包括动画控制、画布绘制、计算结果和更新图表等功能
        
        /* 
        // 蒲丰投针实现代码将放在这里
        
        // 高尔顿钉板实现代码将放在这里
        
        // 生日问题实现代码将放在这里
        
        // 分房问题实现代码将放在这里
        */
       // 蒲丰投针实现代码
const buffonCanvas = document.getElementById('buffonCanvas');
const buffonCtx = buffonCanvas.getContext('2d');
let buffonAnimationId = null;
let buffonNeedles = [];
let buffonResults = {
    total: 0,
    crossings: 0,
    piEstimates: []
};

function drawBuffonLines() {
    const spacing = buffonCanvas.height / 10;
    buffonCtx.strokeStyle = '#3498db';
    buffonCtx.lineWidth = 1;
    
    for (let i = 0; i <= 10; i++) {
        const y = i * spacing;
        buffonCtx.beginPath();
        buffonCtx.moveTo(0, y);
        buffonCtx.lineTo(buffonCanvas.width, y);
        buffonCtx.stroke();
    }
}

function drawNeedle(needle) {
    buffonCtx.save();
    buffonCtx.translate(needle.x, needle.y);
    buffonCtx.rotate(needle.angle);
    
    buffonCtx.strokeStyle = needle.crosses ? '#e74c3c' : '#2ecc71';
    buffonCtx.lineWidth = 2;
    
    buffonCtx.beginPath();
    buffonCtx.moveTo(-needle.length / 2, 0);
    buffonCtx.lineTo(needle.length / 2, 0);
    buffonCtx.stroke();
    
    buffonCtx.restore();
}

function drawAllNeedles() {
    buffonCtx.clearRect(0, 0, buffonCanvas.width, buffonCanvas.height);
    drawBuffonLines();
    buffonNeedles.forEach(drawNeedle);
}

function dropNeedle() {
    const needleLength = parseFloat(document.getElementById('needleLength').value);
    const spacing = buffonCanvas.height / 10;
    const actualLength = spacing * needleLength;
    
    const x = Math.random() * buffonCanvas.width;
    const y = Math.random() * buffonCanvas.height;
    const angle = Math.random() * Math.PI;
    
    // 检查是否与线相交
    const minY = y - Math.abs(Math.sin(angle) * actualLength / 2);
    const maxY = y + Math.abs(Math.sin(angle) * actualLength / 2);
    
    let crosses = false;
    for (let i = 0; i <= 10; i++) {
        const lineY = i * spacing;
        if (minY <= lineY && maxY >= lineY) {
            crosses = true;
            break;
        }
    }
    
    const needle = { x, y, angle, length: actualLength, crosses };
    buffonNeedles.push(needle);
    
    buffonResults.total++;
    if (crosses) buffonResults.crossings++;
    
    const piEstimate = buffonResults.total > 0 ? 
        (2 * needleLength * buffonResults.total) / buffonResults.crossings : 0;
    buffonResults.piEstimates.push(piEstimate);
    
    // 更新UI
    document.getElementById('totalNeedles').textContent = buffonResults.total;
    document.getElementById('crossings').textContent = buffonResults.crossings;
    document.getElementById('piEstimate').textContent = piEstimate.toFixed(6);
    document.getElementById('piError').textContent = 
        Math.abs((Math.PI - piEstimate) / Math.PI * 100).toFixed(4) + '%';
    
    // 更新图表
    if (window.buffonChart) {
        window.buffonChart.data.labels.push(buffonResults.total.toString());
        window.buffonChart.data.datasets[0].data.push(piEstimate);
        window.buffonChart.update();
    }
    
    drawAllNeedles();
    return buffonResults.total < parseInt(document.getElementById('needleCount').value);
}

function startBuffonSimulation() {
    const speed = document.getElementById('animationSpeed').value;
    const speeds = { slow: 500, medium: 100, fast: 20, instant: 0 };
    const delay = speeds[speed];
    
    if (delay === 0) {
        // 立即完成
        const total = parseInt(document.getElementById('needleCount').value);
        for (let i = 0; i < total; i++) {
            dropNeedle();
        }
    } else {
        // 动画模式
        function animate() {
            const continueAnimation = dropNeedle();
            if (continueAnimation) {
                buffonAnimationId = setTimeout(animate, delay);
            }
        }
        animate();
    }
}

function resetBuffonSimulation() {
    if (buffonAnimationId) {
        clearTimeout(buffonAnimationId);
        buffonAnimationId = null;
    }
    
    buffonNeedles = [];
    buffonResults = { total: 0, crossings: 0, piEstimates: [] };
    
    document.getElementById('totalNeedles').textContent = '0';
    document.getElementById('crossings').textContent = '0';
    document.getElementById('piEstimate').textContent = '0';
    document.getElementById('piError').textContent = '0%';
    
    if (window.buffonChart) {
        window.buffonChart.data.labels = [];
        window.buffonChart.data.datasets[0].data = [];
        window.buffonChart.update();
    }
    
    drawAllNeedles();
}

// 初始化蒲丰投针
drawBuffonLines();

// 高尔顿钉板实现代码
const galtonCanvas = document.getElementById('galtonCanvas');
const galtonCtx = galtonCanvas.getContext('2d');
let galtonAnimationId = null;
let galtonResults = {
    ballsDropped: 0,
    distribution: []
};

function drawGaltonBoard() {
    const rows = parseInt(document.getElementById('boardRows').value);
    const cols = rows;
    const spacing = Math.min(galtonCanvas.width, galtonCanvas.height) / (rows + 2);
    
    galtonCtx.clearRect(0, 0, galtonCanvas.width, galtonCanvas.height);
    
    // 绘制钉子
    galtonCtx.fillStyle = '#2c3e50';
    for (let row = 0; row < rows; row++) {
        const y = (row + 1) * spacing;
        const offset = (galtonCanvas.width - (row + 1) * spacing) / 2;
        
        for (let col = 0; col <= row; col++) {
            const x = offset + col * spacing + spacing / 2;
            galtonCtx.beginPath();
            galtonCtx.arc(x, y, 3, 0, Math.PI * 2);
            galtonCtx.fill();
        }
    }
    
    // 绘制槽位
    const slotWidth = spacing;
    const slotHeight = 20;
    const slotTop = galtonCanvas.height - slotHeight;
    
    galtonCtx.fillStyle = '#ecf0f1';
    for (let i = 0; i <= rows; i++) {
        const x = (galtonCanvas.width - (rows + 1) * slotWidth) / 2 + i * slotWidth;
        galtonCtx.fillRect(x, slotTop, slotWidth, slotHeight);
    }
    
    // 绘制分布
    if (galtonResults.distribution.length > 0) {
        const maxBalls = Math.max(...galtonResults.distribution);
        galtonCtx.fillStyle = '#4a69bd';
        
        for (let i = 0; i < galtonResults.distribution.length; i++) {
            const x = (galtonCanvas.width - (rows + 1) * slotWidth) / 2 + i * slotWidth;
            const height = (galtonResults.distribution[i] / maxBalls) * (slotTop - rows * spacing);
            galtonCtx.fillRect(x + 2, slotTop - height, slotWidth - 4, height);
        }
    }
}

function dropBall() {
    const rows = parseInt(document.getElementById('boardRows').value);
    let position = 0;
    
    for (let i = 0; i < rows; i++) {
        position += Math.random() > 0.5 ? 0.5 : -0.5;
    }
    
    const slot = Math.round((position + rows / 2) * 2) / 2;
    const normalizedSlot = Math.min(Math.max(slot, 0), rows);
    
    if (!galtonResults.distribution[normalizedSlot]) {
        galtonResults.distribution[normalizedSlot] = 0;
    }
    galtonResults.distribution[normalizedSlot]++;
    galtonResults.ballsDropped++;
    
    // 更新UI
    document.getElementById('ballsDropped').textContent = galtonResults.ballsDropped;
    
    // 更新图表
    if (window.galtonChart) {
        const labels = Array.from({length: rows + 1}, (_, i) => i.toString());
        window.galtonChart.data.labels = labels;
        window.galtonChart.data.datasets[0].data = labels.map((_, i) => galtonResults.distribution[i] || 0);
        window.galtonChart.update();
    }
    
    drawGaltonBoard();
    return galtonResults.ballsDropped < parseInt(document.getElementById('ballCount').value);
}

function startGaltonSimulation() {
    const speed = document.getElementById('galtonAnimationSpeed').value;
    const speeds = { slow: 200, medium: 50, fast: 10, instant: 0 };
    const delay = speeds[speed];
    
    if (delay === 0) {
        // 立即完成
        const total = parseInt(document.getElementById('ballCount').value);
        for (let i = 0; i < total; i++) {
            dropBall();
        }
    } else {
        // 动画模式
        function animate() {
            const continueAnimation = dropBall();
            if (continueAnimation) {
                galtonAnimationId = setTimeout(animate, delay);
            }
        }
        animate();
    }
}

function resetGaltonSimulation() {
    if (galtonAnimationId) {
        clearTimeout(galtonAnimationId);
        galtonAnimationId = null;
    }
    
    galtonResults = {
        ballsDropped: 0,
        distribution: []
    };
    
    document.getElementById('ballsDropped').textContent = '0';
    document.getElementById('distributionShape').textContent = '-';
    
    if (window.galtonChart) {
        window.galtonChart.data.labels = [];
        window.galtonChart.data.datasets[0].data = [];
        window.galtonChart.update();
    }
    
    drawGaltonBoard();
}

// 初始化高尔顿钉板
drawGaltonBoard();

// 生日问题实现代码
const birthdayCanvas = document.getElementById('birthdayCanvas');
const birthdayCtx = birthdayCanvas.getContext('2d');
let birthdayResults = {
    simulations: 0,
    matches: 0,
    probabilities: []
};

function simulateBirthday() {
    const groupSize = parseInt(document.getElementById('groupSize').value);
    const birthdays = new Set();
    let hasMatch = false;
    
    for (let i = 0; i < groupSize; i++) {
        const day = Math.floor(Math.random() * 365) + 1;
        if (birthdays.has(day)) {
            hasMatch = true;
            break;
        }
        birthdays.add(day);
    }
    
    birthdayResults.simulations++;
    if (hasMatch) birthdayResults.matches++;
    
    const probability = birthdayResults.matches / birthdayResults.simulations;
    birthdayResults.probabilities.push(probability);
    
    // 计算理论概率
    let theoretical = 1;
    for (let i = 1; i < groupSize; i++) {
        theoretical *= (365 - i) / 365;
    }
    theoretical = 1 - theoretical;
    
    // 更新UI
    document.getElementById('simulationsRun').textContent = birthdayResults.simulations;
    document.getElementById('sameBirthdayRatio').textContent = (probability * 100).toFixed(2) + '%';
    document.getElementById('theoreticalProbability').textContent = (theoretical * 100).toFixed(2) + '%';
    
    // 更新图表
    if (window.birthdayChart) {
        if (!window.birthdayChart.data.labels.includes(groupSize.toString())) {
            window.birthdayChart.data.labels.push(groupSize.toString());
            window.birthdayChart.data.datasets[0].data.push(probability);
            window.birthdayChart.data.datasets[1].data.push(theoretical);
        } else {
            const index = window.birthdayChart.data.labels.indexOf(groupSize.toString());
            window.birthdayChart.data.datasets[0].data[index] = probability;
        }
        window.birthdayChart.update();
    }
    
    drawBirthdayVisualization(birthdays, hasMatch);
    return birthdayResults.simulations < parseInt(document.getElementById('simulationCount').value);
}

function drawBirthdayVisualization(birthdays, hasMatch) {
    birthdayCtx.clearRect(0, 0, birthdayCanvas.width, birthdayCanvas.height);
    
    // 绘制日历
    const days = Array.from(birthdays);
    const cellSize = 15;
    const cols = 31;
    const rows = 12;
    
    birthdayCtx.strokeStyle = '#bdc3c7';
    birthdayCtx.fillStyle = hasMatch ? '#e74c3c' : '#2ecc71';
    
    for (let i = 0; i < days.length; i++) {
        const day = days[i];
        const month = Math.ceil(day / 31) - 1;
        const dayOfMonth = day % 31 || 31;
        
        const x = (dayOfMonth - 1) * cellSize;
        const y = month * cellSize;
        
        birthdayCtx.fillRect(x, y, cellSize - 1, cellSize - 1);
    }
    
    birthdayCtx.fillStyle = '#34495e';
    birthdayCtx.font = '10px Arial';
    birthdayCtx.textAlign = 'center';
    birthdayCtx.textBaseline = 'middle';
    
    for (let month = 0; month < rows; month++) {
        for (let day = 0; day < cols; day++) {
            const x = day * cellSize + cellSize / 2;
            const y = month * cellSize + cellSize / 2;
            
            if (day < 28 || (month !== 1 && day < 31)) {
                birthdayCtx.fillText((day + 1).toString(), x, y);
            }
        }
    }
}

function startBirthdaySimulation() {
    const total = parseInt(document.getElementById('simulationCount').value);
    
    for (let i = 0; i < total; i++) {
        simulateBirthday();
    }
}

function resetBirthdaySimulation() {
    birthdayResults = {
        simulations: 0,
        matches: 0,
        probabilities: []
    };
    
    document.getElementById('simulationsRun').textContent = '0';
    document.getElementById('sameBirthdayRatio').textContent = '0%';
    document.getElementById('theoreticalProbability').textContent = '0%';
    
    if (window.birthdayChart) {
        window.birthdayChart.data.labels = [];
        window.birthdayChart.data.datasets[0].data = [];
        window.birthdayChart.data.datasets[1].data = [];
        window.birthdayChart.update();
    }
    
    birthdayCtx.clearRect(0, 0, birthdayCanvas.width, birthdayCanvas.height);
}

// 分房问题实现代码
const roomCanvas = document.getElementById('roomCanvas');
const roomCtx = roomCanvas.getContext('2d');
let roomResults = {
    rooms: [],
    distribution: []
};

function simulateRoomAssignment() {
    const roomCount = parseInt(document.getElementById('roomCount').value);
    const guestCount = parseInt(document.getElementById('guestCount').value);
    
    // 初始化房间
    roomResults.rooms = Array(roomCount).fill(0);
    roomResults.distribution = Array(guestCount + 1).fill(0);
    
    // 分配客人
    for (let i = 0; i < guestCount; i++) {
        const room = Math.floor(Math.random() * roomCount);
        roomResults.rooms[room]++;
    }
    
    // 计算分布
    roomResults.rooms.forEach(guests => {
        roomResults.distribution[guests] = (roomResults.distribution[guests] || 0) + 1;
    });
    
    // 计算结果
    const emptyRooms = roomResults.rooms.filter(g => g === 0).length;
    const maxGuests = Math.max(...roomResults.rooms);
    const avgGuests = guestCount / roomCount;
    
    // 确定分布类型
    let distributionType = '近似均匀分布';
    if (guestCount / roomCount < 0.1) {
        distributionType = '近似泊松分布';
    } else if (guestCount / roomCount > 10) {
        distributionType = '近似正态分布';
    }
    
    // 更新UI
    document.getElementById('emptyRooms').textContent = emptyRooms;
    document.getElementById('maxGuests').textContent = maxGuests;
    document.getElementById('avgGuests').textContent = avgGuests.toFixed(2);
    document.getElementById('distributionType').textContent = distributionType;
    
    // 更新图表
    if (window.roomChart) {
        const maxDisplay = Math.min(20, maxGuests); // 限制显示范围
        const labels = Array.from({length: maxDisplay + 1}, (_, i) => i.toString());
        const data = labels.map((_, i) => roomResults.distribution[i] || 0);
        
        window.roomChart.data.labels = labels;
        window.roomChart.data.datasets[0].data = data;
        window.roomChart.update();
    }
    
    drawRoomVisualization();
}

function drawRoomVisualization() {
    roomCtx.clearRect(0, 0, roomCanvas.width, roomCanvas.height);
    
    const roomCount = roomResults.rooms.length;
    const cols = Math.ceil(Math.sqrt(roomCount));
    const rows = Math.ceil(roomCount / cols);
    const cellSize = Math.min(roomCanvas.width / cols, roomCanvas.height / rows);
    
    const maxGuests = Math.max(...roomResults.rooms);
    
    roomResults.rooms.forEach((guests, index) => {
        const col = index % cols;
        const row = Math.floor(index / cols);
        
        const x = col * cellSize;
        const y = row * cellSize;
        
        // 绘制房间
        roomCtx.strokeStyle = '#bdc3c7';
        roomCtx.strokeRect(x, y, cellSize, cellSize);
        
        // 绘制客人
        if (guests > 0) {
            const intensity = Math.min(1, guests / maxGuests);
            roomCtx.fillStyle = `rgba(74, 105, 189, ${0.3 + 0.7 * intensity})`;
            roomCtx.fillRect(x, y, cellSize, cellSize);
            
            roomCtx.fillStyle = '#2c3e50';
            roomCtx.font = '12px Arial';
            roomCtx.textAlign = 'center';
            roomCtx.textBaseline = 'middle';
            roomCtx.fillText(guests.toString(), x + cellSize / 2, y + cellSize / 2);
        }
    });
}

function startRoomSimulation() {
    simulateRoomAssignment();
}

function resetRoomSimulation() {
    roomResults = {
        rooms: [],
        distribution: []
    };
    
    document.getElementById('emptyRooms').textContent = '0';
    document.getElementById('maxGuests').textContent = '0';
    document.getElementById('avgGuests').textContent = '0';
    document.getElementById('distributionType').textContent = '-';
    
    if (window.roomChart) {
        window.roomChart.data.labels = [];
        window.roomChart.data.datasets[0].data = [];
        window.roomChart.update();
    }
    
    roomCtx.clearRect(0, 0, roomCanvas.width, roomCanvas.height);
}
// 预设场景处理
document.getElementById('preset').addEventListener('change', function() {
    const preset = this.value;
    
    switch(preset) {
        case 'birthday':
            document.getElementById('roomCount').value = 365;
            document.getElementById('guestCount').value = 23;
            break;
        case 'coupon':
            document.getElementById('roomCount').value = 100;
            document.getElementById('guestCount').value = 600;
            break;
        case 'hash':
            document.getElementById('roomCount').value = 100;
            document.getElementById('guestCount').value = 80;
            break;
    }
});

// 绑定按钮事件
document.getElementById('startBuffon').addEventListener('click', startBuffonSimulation);
document.getElementById('resetBuffon').addEventListener('click', resetBuffonSimulation);
document.getElementById('startGalton').addEventListener('click', startGaltonSimulation);
document.getElementById('resetGalton').addEventListener('click', resetGaltonSimulation);
document.getElementById('startBirthday').addEventListener('click', startBirthdaySimulation);
document.getElementById('resetBirthday').addEventListener('click', resetBirthdaySimulation);
document.getElementById('startRoom').addEventListener('click', startRoomSimulation);
document.getElementById('resetRoom').addEventListener('click', resetRoomSimulation);
    </script>
</body>
</html>